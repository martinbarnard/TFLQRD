<!doctype html>

<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="css.css?">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Codystar" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Sacramento" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <meta charset="utf-8">
  <!-- TODO: dynamic title -->
  <title> Bus Thang </title>

  <meta name="description" content="">


</head>
<body>
    <div id="holder" class="container-fluid">
      <div id="title"> <b> Market Place, Brentford  </b> </div>

      <div class="progress">
          <div id="prbar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
      </div>

      <div class="row">
        <div id="inbound_container" class="col">
            <h2>Inbound (East)</h2>
            <div id="inbound"> </div>
        </div>
        <div id="outbound_container" class="col">
            <h2>Outbound (West)</h2>
            <div id="outbound"> </div>
        </div>
      </div>
    </div>
  <div id="credit_where_due">
          <a href="https://api.tfl.gov.uk/" target="_blank">TFL API (Thanks, TFL!)</a>
      <div><a id="josh" href="https://github.com/joshburns1993"> Joshua Burns </a></div>
  </div>
          <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>

        var buses = ['237', '267'];
        // platformName is one of 'BN' or 'BL'
        // inbound (i.e. eastbound, towards Chiswick) is  BN - 490004292f
        // outbound (i.e. westbound, towards Hounslow) is BL - 490004292G
        // Another useful url: https://api.tfl.gov.uk/StopPoint/490004292f%2C490004292g

        var url ='https://api.tfl.gov.uk/Stoppoint/490004292f/arrivals';
        var url2='https://api.tfl.gov.uk/Stoppoint/490004292g/arrivals';
        var refresh_time = 30 * 1000; // when to re-run, in milliseconds
        var separator = ' - ';

        var p = document.getElementById('prbar');
        var prtimer = refresh_time;
        p['aria-valuemax']=(refresh_time / 1000);
        p['aria-valuenow']=0;
        p.innerHtml=0;



        // Our timed things
        var inbound_stuff   = setInterval(getData, refresh_time, url, 'BN', 'inbound');
        var outbound_stuff  = setInterval(getData, refresh_time, url2, 'BL', 'outbound');
        var progress_bar    = setInterval(doProgress,1000);
            


        // TODO: Sort by time
        function getData(url, platform, divId ) {
            var arr = [];
            var divObj =  document.getElementById(divId);
            var ul = document.createElement('UL');
            ul.className = "list-group";

            while (divObj.hasChildNodes()) {
                divObj.removeChild(divObj.firstChild);
            }

            $.getJSON(url, function(data) {
                console.log('Polling api for', divId);
                data.sort(compare);
                data.forEach(function (j) { 
                    j.eta = new Date(j.expectedArrival);
                    if ((buses.indexOf(j.lineName) != -1) && (j.platformName == platform)) {
                        var p = document.createElement('LI');
                        p.className="list-group-item list-group-item-action";
                        p.innerHTML=j.lineName + separator + j.eta.toLocaleString([], {hour: '2-digit', minute:'2-digit'});
                        ul.appendChild(p);
                    }
                });

            });
            divObj.appendChild(ul);
            
        };

        function compare(a,b) {
            // Compare times 
            const eta_a = new Date(a.expectedArrival);
            const eta_b = new Date(b.expectedArrival);

            if (eta_a > eta_b) {
                return 1;
            } else if (eta_a  < eta_b) {
                return -1;
            }
            return 0;
        };

        // Function to update the progress bar
        function doProgress() {
            var rtl = prtimer / 1000;

            // calculate % of width
            ptl = (prtimer / refresh_time) * 100;
            $('.progress-bar').css('width', ptl + '%').attr('aria-valuenow',rtl);
            $('.progress-bar').innerHtml=rtl;
            

            prtimer = prtimer - 1000;
            if (prtimer <= 100) {
                prtimer = refresh_time
            };

        };

    </script>

</body>
</html>
